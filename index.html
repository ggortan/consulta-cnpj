<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <title>Consultar CNPJ v3 - BrasilAPI</title>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="btn btn-sm btn-primary me-3" role="button" href="https://dev.gortan.com.br/tools/"><i class="bi bi-arrow-left"></i></a>
            <a class="navbar-brand" href="#">Consulta CNPJ v3</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./historico.html">Histórico</a>
                    </li>
                </ul>
                <span class="navbar-text me-3">
                    Digite o CNPJ que deseja consultar:
                </span>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" id="cnpj" type="text" placeholder="00.000.000/0000-00" data-mask="00.000.000/0000-00" aria-label="Cosultar">
                    <div id="consultar" class="btn btn-outline-success" onclick="callcnpj(cnpj.value)">
                        <span id="loading-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span id="btn-text">Consultar</span>
                    </div>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mb-3 mt-3">
        <form class="row g-4">
            <div class="row mt-4">
                <div class="col-sm-6">
                    <ul class="list-group">
                        <li class="list-group-item">
                            Situação: <span id="situacao" class="placeholder col-1"></span> 
                            Data da Situação: <span id="data-situacao" class="placeholder col-1"></span>
                        </li>
                    </ul>
                </div>
                <div class="col-sm-6">
                    <ul class="list-group">
                        <li class="list-group-item">
                            Consulta: <span id="status" class=""></span> 
                            <span id="ultima-atualizacao" class="placeholder col-7"></span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="row mb-3">
                    <label for="cnpj-campo" class="col-sm-3 col-form-label">CNPJ</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="cnpj-campo" class="form-control" data-mask="00.000.000/0000-00" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="razao-social" class="col-sm-3 col-form-label">R. Social</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="razao-social" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="nome-fantasia" class="col-sm-3 col-form-label">Nome Fantasia</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="nome-fantasia" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Telefone</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="telefone" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="natureza-juridica" class="col-sm-3 col-form-label">Nat. Jurídica</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="natureza-juridica" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="porte" class="col-sm-3 col-form-label">Porte</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="porte" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="row mb-3">
                    <label for="logradouro" class="col-sm-3 col-form-label">Logradouro</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="logradouro" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="bairro" class="col-sm-3 col-form-label">Bairro</label>
                    <div class="col-sm-5">
                        <input disabled type="text" id="bairro" class="form-control" />
                    </div>
                    <label for="numero" class="col-sm-2 col-form-label">Número</label>
                    <div class="col-sm-2">
                        <input disabled type="text" id="numero" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="complemento" class="col-sm-3 col-form-label">Complemento</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="complemento" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="municipio" class="col-sm-3 col-form-label">Município</label>
                    <div class="col-sm-6">
                        <input disabled type="text" id="municipio" class="form-control" />
                    </div>
                    <label for="uf" class="col-sm-1 col-form-label">UF</label>
                    <div class="col-sm-2">
                        <input disabled type="text" id="uf" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="cep" class="col-sm-3 col-form-label">CEP</label>
                    <div class="col-sm-6">
                        <input disabled type="text" id="cep" class="form-control" />
                    </div>
                </div>
                <div class="row mb-3">
                    <label for="email" class="col-sm-3 col-form-label">Email</label>
                    <div class="col-sm-9">
                        <input disabled type="text" id="email" class="form-control" />
                    </div>
                </div>
            </div>
        </form>

        <div class="row g-2">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header">
                        Quadro de Sócios e Administradores
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="membros">
                            <!-- Sócios e Administradores serão preenchidos aqui -->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header">
                        Atividades
                    </div>
                    <div class="card-body">
                        <h6>Atividade Principal</h6>
                        <ul class="list-group" id="atividade-principal">
                            <!-- Atividades Principais serão preenchidas aqui -->
                        </ul>
                        <h6 class="mt-3">Atividades Secundárias</h6>
                        <ul class="list-group" id="atividades-secundarias">
                            <!-- Atividades Secundárias serão preenchidas aqui -->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Retorno JSON
                    </div>
                    <div class="card-body">
                        <pre id="retorno-cru" class="bg-light p-3 rounded" style="font-size: 0.85em; max-height: 400px; overflow-y: auto;">
                            <!-- Retorno JSON será exibido aqui -->
                        </pre>
                    </div>
                </div>
            </div>
        </div>

        <footer class="d-flex flex-wrap justify-content-between align-items-center my-4 border-top">
            <p class="col-md-4 mb-0 text-muted">Projeto de API - Gabriel G.</p>
            <p class="mb-0 text-muted text-center">Versão: 3.0.0 - BrasilAPI</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função chamada ao pressionar o botão de consulta
        function callcnpj(cnpj) {
            const cnpjLimpo = cnpj.replace(/[^0-9]/g, '');
            
            // Validação básica do CNPJ
            if (cnpjLimpo.length !== 14) {
                alert('CNPJ deve ter 14 dígitos');
                return;
            }

            // Mostra loading
            const loadingSpinner = document.getElementById('loading-spinner');
            const btnText = document.getElementById('btn-text');
            const consultarBtn = document.getElementById('consultar');
            
            loadingSpinner.classList.remove('d-none');
            btnText.textContent = 'Consultando...';
            consultarBtn.disabled = true;

            // Limpa campos anteriores
            limparCampos();

            fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpjLimpo}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    preencherCampos(data);
                    salvarHistorico(data);
                })
                .catch(error => {
                    console.error('Erro na consulta:', error);
                    document.getElementById('status').textContent = 'ERRO';
                    document.getElementById('status').className = 'badge bg-danger';
                    alert('Erro ao consultar CNPJ. Verifique se o número está correto.');
                })
                .finally(() => {
                    // Remove loading
                    loadingSpinner.classList.add('d-none');
                    btnText.textContent = 'Consultar';
                    consultarBtn.disabled = false;
                });
        }

        function limparCampos() {
            const campos = [
                'situacao', 'data-situacao', 'status', 'ultima-atualizacao',
                'cnpj-campo', 'razao-social', 'nome-fantasia', 'telefone',
                'natureza-juridica', 'porte', 'logradouro', 'bairro', 'numero',
                'complemento', 'municipio', 'uf', 'cep', 'email'
            ];
            
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    if (elemento.tagName === 'INPUT') {
                        elemento.value = '';
                    } else {
                        elemento.textContent = '';
                        elemento.className = 'placeholder col-1';
                    }
                }
            });

            // Limpa listas
            document.getElementById('membros').innerHTML = '';
            document.getElementById('atividade-principal').innerHTML = '';
            document.getElementById('atividades-secundarias').innerHTML = '';
            document.getElementById('retorno-cru').textContent = '';
        }

        function preencherCampos(data) {
            // Status da consulta
            document.getElementById('status').textContent = 'OK';
            document.getElementById('status').className = 'badge bg-success';
            
            // Situação cadastral
            const situacao = data.descricao_situacao_cadastral || 'N/A';
            document.getElementById('situacao').textContent = situacao;
            document.getElementById('situacao').className = situacao === 'ATIVA' ? 'badge bg-success' : 'badge bg-warning';
            
            // Data da situação
            const dataSituacao = data.data_situacao_cadastral || '';
            if (dataSituacao) {
                const dataFormatada = new Date(dataSituacao).toLocaleDateString('pt-BR');
                document.getElementById('data-situacao').textContent = dataFormatada;
                document.getElementById('data-situacao').className = 'badge bg-light text-dark';
            }

            // Última atualização (usando data de início da atividade)
            const dataInicio = data.data_inicio_atividade || '';
            if (dataInicio) {
                const dataFormatada = new Date(dataInicio).toLocaleDateString('pt-BR');
                document.getElementById('ultima-atualizacao').textContent = `Início: ${dataFormatada}`;
                document.getElementById('ultima-atualizacao').className = 'badge bg-light text-dark';
            }

            // Dados básicos
            document.getElementById('cnpj-campo').value = formatarCNPJ(data.cnpj);
            document.getElementById('razao-social').value = data.razao_social || '';
            document.getElementById('nome-fantasia').value = data.nome_fantasia || '';
            document.getElementById('natureza-juridica').value = data.natureza_juridica || '';
            document.getElementById('porte').value = data.porte || '';
            document.getElementById('email').value = data.email || '';

            // Telefone
            const telefone = data.ddd_telefone_1 || '';
            if (telefone) {
                document.getElementById('telefone').value = formatarTelefone(telefone);
            }

            // Endereço
            const logradouro = data.descricao_tipo_de_logradouro ? 
                `${data.descricao_tipo_de_logradouro} ${data.logradouro}` : 
                data.logradouro || '';
            document.getElementById('logradouro').value = logradouro;
            document.getElementById('bairro').value = data.bairro || '';
            document.getElementById('numero').value = data.numero || '';
            document.getElementById('complemento').value = data.complemento || '';
            document.getElementById('municipio').value = data.municipio || '';
            document.getElementById('uf').value = data.uf || '';
            document.getElementById('cep').value = formatarCEP(data.cep);

            // Atividade principal
            const atividadePrincipalEl = document.getElementById('atividade-principal');
            if (data.cnae_fiscal && data.cnae_fiscal_descricao) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${data.cnae_fiscal} - ${data.cnae_fiscal_descricao}`;
                atividadePrincipalEl.appendChild(li);
            }

            // Atividades secundárias
            const atividadesSecundariasEl = document.getElementById('atividades-secundarias');
            if (data.cnaes_secundarios && data.cnaes_secundarios.length > 0) {
                data.cnaes_secundarios.forEach(atividade => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${atividade.codigo} - ${atividade.descricao}`;
                    atividadesSecundariasEl.appendChild(li);
                });
            }

            // Quadro societário
            const membrosEl = document.getElementById('membros');
            if (data.qsa && data.qsa.length > 0) {
                data.qsa.forEach(socio => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-start';
                    
                    const div = document.createElement('div');
                    div.className = 'ms-2 me-auto';
                    
                    const nome = document.createElement('div');
                    nome.className = 'fw-bold';
                    nome.textContent = socio.nome_socio || '';
                    
                    const cargo = document.createElement('small');
                    cargo.className = 'text-muted';
                    cargo.textContent = socio.qualificacao_socio || '';
                    
                    div.appendChild(nome);
                    div.appendChild(cargo);
                    
                    if (socio.faixa_etaria) {
                        const idade = document.createElement('span');
                        idade.className = 'badge bg-secondary rounded-pill';
                        idade.textContent = socio.faixa_etaria;
                        li.appendChild(div);
                        li.appendChild(idade);
                    } else {
                        li.appendChild(div);
                    }
                    
                    membrosEl.appendChild(li);
                });
            }

            // Retorno JSON
            document.getElementById('retorno-cru').textContent = JSON.stringify(data, null, 2);
        }

        function salvarHistorico(data) {
            let historico = JSON.parse(localStorage.getItem('historico_cnpjs')) || [];
            const novaEntrada = {
                cnpj: formatarCNPJ(data.cnpj),
                rsocial: data.razao_social || '',
                data: new Date().toLocaleDateString('pt-BR')
            };
            
            // Remove duplicatas
            historico = historico.filter(item => item.cnpj !== novaEntrada.cnpj);
            
            // Adiciona no início
            historico.unshift(novaEntrada);
            
            // Mantém apenas os últimos 50 registros
            if (historico.length > 50) {
                historico = historico.slice(0, 50);
            }
            
            localStorage.setItem('historico_cnpjs', JSON.stringify(historico));
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '';
            return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }

        function formatarCEP(cep) {
            if (!cep) return '';
            return cep.replace(/^(\d{5})(\d{3})$/, '$1-$2');
        }

        function formatarTelefone(telefone) {
            if (!telefone) return '';
            if (telefone.length === 11) {
                return telefone.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            } else if (telefone.length === 10) {
                return telefone.replace(/^(\d{2})(\d{4})(\d{4})$/, '($1) $2-$3');
            }
            return telefone;
        }

        // Adiciona o evento keypress ao campo de CNPJ
        document.getElementById("cnpj").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("consultar").click();
            }
        });

        // Aplicar máscara no campo CNPJ
        $(document).ready(function() {
            $('#cnpj').mask('00.000.000/0000-00');
        });
    </script>
</body>
</html>
